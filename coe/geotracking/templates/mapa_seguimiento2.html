{% extends 'base_informacion.html' %}

{% load static %}

{% block custom_head %}
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.21/datatables.min.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjRgLoGbbsT98rbPveyxjLPdSOvYCUH_8&libraries=places" async defer></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.21/datatables.min.js"></script>

    <script type="text/javascript">
        var $minimap;
        var $tblAlertas;
        var defaultLatLng;

        var JSONData = {{datos|safe}};

        $(document).ready(function() {

            iniciarGmap();

            $minimap.markers = [];

            $tblAlertas = $('#tablaAlertas').DataTable({
                data: JSONData.geoposiciones,
                searching: false,
                paging: false,
                scrollY: '65vh',
                scrollX: false,
                scrollCollapse: true,
                buttons: [],
                order: [ 1, 'desc' ], 
                columns: [
                    {
                        data: null,
                        orderable: false,
                        render: function (data, type, row) {
                            var $link;
                            $link = `<a href="javascript:void(0)" title="Ver Punto" btn-marker=""><img src="http://coe.jujuy.gob.ar/static/${row.icono}" alt="sin imagen"></a>`;
                            return $link;
                        }
                    },
                    {
                        title: "FECHA Y HORA",
                        data: 'fecha',
                        orderable: false,
                        render: function(data, type, row) {
                            var texto;
                            var fecha = row.fecha.split('-').reverse().join('/');
                            texto =  fecha + ` ${row.hora}`;
                            return texto;
                        }
                    },
                    {
                        title: "REPORTE DISTANCIA",
                        render: function(data, type, row) {
                            var texto;
                            texto =  `${row.tipo} ${row.distancia}m. de base`;
                            return texto;
                        },
                    },
                    { 
                        title: "ACLARACION",
                        data: 'aclaracion',
                    },
                ],
                createdRow: function (row, data, dataIndex) {
                    //una vez creada la fila crear el icono en el mapa
                    data.rowId = dataIndex;
                    data.fecha_dmy = data.fecha.split('-').reverse().join('/');
                    $(row).attr('id' , 'tr' + dataIndex);
                    var marker = addMarker(data);
                    $minimap.markers.push(marker);
                },

            } );

            $(".apellido").html(JSONData.apellidos);
            $(".nombres").html(JSONData.nombres);
            $(".num_doc").html(JSONData.num_doc);
            $(".domicilio").html(JSONData.domicilio);
            $(".telefono").html(JSONData.telefono);
            $(".situacion").html(JSONData.situacion);


            $('.dni_frente').attr('src', 'http://coe.jujuy.gob.ar' + JSONData.DNI_Front);
            $('.dni_dorso').attr('src', 'http://coe.jujuy.gob.ar' + JSONData.DNI_Back);

        });

        $(document).on('click', '[btn-marker]', function(event) {
            event.preventDefault;
            var $tr = $(this).closest('tr');
            var row = $tblAlertas.row($tr);
            var rowData = row.data();
            var marker = $minimap.markers[rowData.rowId];

            animateMarker(marker);
        });

        /* Funciones googlemaps */
        function iniciarGmap() {
            var minimapDiv = document.getElementById('minimap');
            var circuloVerde;
            var circuloAmarillo;
            var zoom;
            zoom = 12;
            {% if mapeador.gps_base %}
                defaultLatLng = new google.maps.LatLng(JSONData.base_latitud, JSONData.base_longitud);
            {% else %}
                defaultLatLng = new google.maps.LatLng(-24.185966775632277,-65.29986124600589);
            {% endif %}

            var opcionesMapa = {
                zoom: zoom,
                center: defaultLatLng,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                styles: [{
                        "featureType": "poi",
                        "stylers": [{ "visibility": "off" }]
                    },
                    {
                        "featureType": "poi.park",
                        "stylers": [{ "visibility": "simplified" }]
                    }
                ]
            };

            $minimap = new google.maps.Map(minimapDiv, opcionesMapa);

            if (JSONData.punto_base){
                circuloVerde = new google.maps.Circle({
                    center: defaultLatLng,
                    radius: JSONData.radio1/2,
                    strokeColor: '#a5ff33',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#a5ff33',
                    fillOpacity: 0.5,
                    editable: false
                });

                circuloAmarillo = new google.maps.Circle({
                    center: defaultLatLng,
                    radius: JSONData.radio2/2,
                    strokeColor: '#ff0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#ffe983',
                    fillOpacity: 0.3,
                    editable: false
                });

                circuloAmarillo.setMap($minimap);
                circuloVerde.setMap($minimap);
            }

        }

        function addMarker(data) {
            var marker;

            marker = new google.maps.Marker({
                map: $minimap,
                position: new google.maps.LatLng(data.latitud, data.longitud),
                draggable: false,
                icon: "http://coe.jujuy.gob.ar/static" + data.icono,
                animation: google.maps.Animation.DROP,
                title: 'Lat. ' + data.latitud + ' / Long. ' + data.longitud,
                data: data
                });

            var contentString = `<h4 class="text-bold"><img src="http://coe.jujuy.gob.ar/static${data.icono}"> ${data.tipo}</h4>
                <div>
                    <p class="text-center">
                        <b>${data.fecha_dmy} ${data.hora}</b><br>
                    </p>
                </div>`;

            var infowindow = new google.maps.InfoWindow({
                content: contentString
            });

            marker.addListener('click', function() {
                infowindow.open(minimap, marker);
                animateMarker(marker);
            });
                
            return marker;
        }

        function animateMarker(mrk) {
            var rowId = '#tr' + mrk.data.rowId;
            if (mrk.getAnimation() !== null) {
                mrk.setAnimation(null);
            } else {
                mrk.setAnimation(google.maps.Animation.BOUNCE);
            }
            mrk.setZIndex(100000);
            $minimap.panTo(mrk.position);
            $(rowId).toggleClass('selected');
        }
    </script>
{% endblock %}

{% block content %}
    	<div class="content-wrapper" style="min-height: 800px; margin-top: 20px;">
        <!-- Main content -->
        <section>
            <div class="row">
                <div id="minimap" class="col-xs-6" style="min-height: 80vh; position: relative; overflow: hidden;">
                </div>
                <div class="col-xs-6">
                    <ul class="nav nav-tabs" role="tablist">
                        <li role="presentation" class="active"><a href="#posiciones_geotracking" aria-controls="posiciones_geotracking" role="tab" data-toggle="tab">Listado Geoposiciones</a></li>
                        <li role="presentation"><a href="#info_persona" aria-controls="info_persona" role="tab" data-toggle="tab">Informacion de la Persona</a></li>
                    </ul>
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane active table-responsive" id="posiciones_geotracking">
                            <table class="table table-striped table-bordered table-condensed dataTable no-footer" id="tablaAlertas" style="width: 99%;">
                            </table>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="info_persona">
                            <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                                <div class="panel panel-default">
                                    <div class="panel-heading" role="tab" id="headingOne">
                                    <h4 class="panel-title">
                                        <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                            Informacion Basica
                                        </a>
                                    </h4>
                                    </div>
                                    <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
                                        <div class="panel-body">
                                            <p>Apellido(s): {{individuo.apellidos}}</p>
                                            <p>Nombre(s): {{individuo.nombres}}</p>
                                            <p>Documento: {{individuo.num_doc}}</p>
                                            <p>Domicilio: {{individuo.domicilio_actual}}</p>
                                            <p>Telefono: {{individuo.telefono}}</p>
                                            <p>Situacion: {{individuo.get_situacion}}</p>
                                            <a href="#" class="btn btn-default btn-marker">
                                                Mostrar Punto Base
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel panel-default">
                                    <div class="panel-heading" role="tab" id="headingTwo">
                                    <h4 class="panel-title">
                                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                            Imagenes Dni:
                                        </a>
                                    </h4>
                                    </div>
                                    <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
                                        <div class="panel-body">
                                            <img src="{{mapeador.dni_frente}}" class="fotos">
                                            <img src="{{mapeador.dni_reverso}}" class="fotos">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- /.content -->
    </div>
{% endblock %}